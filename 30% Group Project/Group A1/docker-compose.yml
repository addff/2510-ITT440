version: '3.8'

services:
  # MySQL Database Container
  database:
    image: mysql:8.0
    container_name: mysql_database
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: network_project
      MYSQL_USER: dbuser
      MYSQL_PASSWORD: dbpassword
    volumes:
      - ./Database/init.sql:/docker-entrypoint-initdb.d/init.sql
      - db_data:/var/lib/mysql
    networks:
      - project_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Python Server 1 - Updates Afif
  server1:
    build:
      context: ./Server_Py
      dockerfile: Dockerfile
    container_name: python_server1
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
      SERVER_PORT: 5001
      USER_NAME: Afif
    ports:
      - "5001:5001"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    command: python server1.py
    profiles: ["afif", "python", "all"]

  # Python Server 2 - Updates Syahmi
  server2:
    build:
      context: ./Server_Py
      dockerfile: Dockerfile
    container_name: python_server2
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
      SERVER_PORT: 5002
      USER_NAME: Syahmi
    ports:
      - "5002:5002"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    command: python server2.py
    profiles: ["syahmi", "python", "all"]

  # Python Client 1 - Connects to Server1
  client1:
    build:
      context: ./Client_Py
      dockerfile: Dockerfile
    container_name: python_client1
    environment:
      SERVER_HOST: server1
      SERVER_PORT: 5001
    depends_on:
      - server1
    networks:
      - project_network
    command: python client1.py
    profiles: ["afif", "python", "all"]

  # Python Client 2 - Connects to Server2
  client2:
    build:
      context: ./Client_Py
      dockerfile: Dockerfile
    container_name: python_client2
    environment:
      SERVER_HOST: server2
      SERVER_PORT: 5002
    depends_on:
      - server2
    networks:
      - project_network
    command: python client2.py
    profiles: ["syahmi", "python", "all"]

  # Python Server 3 - Updates Irfan
  server3:
    build:
      context: ./Server_Py
      dockerfile: Dockerfile
    container_name: python_server3
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
      SERVER_PORT: 5003
      USER_NAME: Irfan
    ports:
      - "5003:5003"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    command: python server3.py
    profiles: ["irfan", "python", "all"]

  # Python Client 3 - Connects to Server3
  client3:
    build:
      context: ./Client_Py
      dockerfile: Dockerfile
    container_name: python_client3
    environment:
      SERVER_HOST: server3
      SERVER_PORT: 5003
    depends_on:
      - server3
    networks:
      - project_network
    command: python client3.py
    profiles: ["irfan", "python", "all"]

  # C Server 1 - Updates Hairiel
  server_c1:
    build:
      context: ./Server_C
      dockerfile: Dockerfile
    container_name: c_server1
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
      SERVER_PORT: 6001
      USER_NAME: Hairiel
    ports:
      - "6001:6001"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    command: ./server1
    profiles: ["hairiel", "c", "all"]

  # C Server 2 - Updates Faiz
  server_c2:
    build:
      context: ./Server_C
      dockerfile: Dockerfile
    container_name: c_server2
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
      SERVER_PORT: 6002
      USER_NAME: Faiz
    ports:
      - "6002:6002"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    command: ./server2
    profiles: ["faiz", "c", "all"]

  # C Client 0 - Connects to Python Server1
  client_c0:
    build:
      context: ./Client_C/sir
      dockerfile: Dockerfile
    container_name: c_client0
    environment:
      SERVER_HOST: server1
      SERVER_PORT: 5001
    depends_on:
      - server1
    networks:
      - project_network
    command: ./client_sir
    profiles: ["sir", "python", "all"]

  # C Client 1 - Connects to C Server1
  client_c1:
    build:
      context: ./Client_C
      dockerfile: Dockerfile
    container_name: c_client1
    environment:
      SERVER_HOST: server_c1
      SERVER_PORT: 6001
    depends_on:
      - server_c1
    networks:
      - project_network
    command: ./client1
    profiles: ["hairiel", "c", "all"]

  # C Client 2 - Connects to C Server2
  client_c2:
    build:
      context: ./Client_C
      dockerfile: Dockerfile
    container_name: c_client2
    environment:
      SERVER_HOST: server_c2
      SERVER_PORT: 6002
    depends_on:
      - server_c2
    networks:
      - project_network
    command: ./client2
    profiles: ["faiz", "c", "all"]

  # Web Dashboard & REST API
  web_dashboard:
    build:
      context: ./WebApp
      dockerfile: Dockerfile
    container_name: web_dashboard
    environment:
      DB_HOST: database
      DB_USER: dbuser
      DB_PASSWORD: dbpassword
      DB_NAME: network_project
    ports:
      - "8080:8080"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    restart: unless-stopped

  # phpMyAdmin for Database Management
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin
    environment:
      PMA_HOST: database
      PMA_PORT: 3306
      PMA_USER: dbuser
      PMA_PASSWORD: dbpassword
      MYSQL_ROOT_PASSWORD: rootpassword
    ports:
      - "8081:80"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - project_network
    restart: unless-stopped

networks:
  project_network:
    driver: bridge

volumes:
  db_data:
